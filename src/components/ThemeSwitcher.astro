---
// Theme Switcher Component
const themes = [
    { value: 'light', label: 'Light', icon: '‚òÄÔ∏è' },
    { value: 'dark', label: 'Dark', icon: 'üåô' },
    { value: 'sandiego-sunset', label: 'San Diego Sunset', icon: 'üåÖ' },
    { value: 'california-ocean', label: 'California Ocean', icon: 'üåä' },
    { value: 'gallery-minimal', label: 'Gallery Minimal', icon: 'üñºÔ∏è' }
];
---

<div class="theme-switcher">
    <button class="theme-toggle" aria-label="Toggle theme menu" type="button">
        <span class="theme-icon">üé®</span>
    </button>
    <div class="theme-menu" hidden>
        {themes.map(theme => (
            <button
                class="theme-option"
                data-theme={theme.value}
                type="button"
            >
                <span class="theme-emoji">{theme.icon}</span>
                <span class="theme-label">{theme.label}</span>
            </button>
        ))}
    </div>
    <div class="keyboard-hint">
        <kbd>Ctrl</kbd> + <kbd>K</kbd>
    </div>
</div>

<style lang="scss">
.theme-switcher {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 9999;
}

.theme-toggle {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--color-accent);
    color: var(--color-bg-primary);
    border: 2px solid var(--color-border);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    box-shadow: var(--shadow-lg);
    transition: transform 0.2s ease, box-shadow 0.2s ease;

    &:hover {
        transform: scale(1.1);
        box-shadow: var(--shadow-md);
    }

    &:active {
        transform: scale(0.95);
    }
}

.theme-menu {
    position: absolute;
    bottom: 70px;
    right: 0;
    background: var(--color-bg-primary);
    border: 2px solid var(--color-border);
    border-radius: 12px;
    padding: 0.5rem;
    min-width: 200px;
    box-shadow: var(--shadow-lg);

    &[hidden] {
        display: none;
    }
}

.theme-option {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border: none;
    background: transparent;
    color: var(--color-text-primary);
    cursor: pointer;
    border-radius: 8px;
    font-size: 1rem;
    transition: background 0.2s ease;

    &:hover {
        background: var(--color-bg-secondary);
    }

    &.active {
        background: var(--color-accent);
        color: var(--color-bg-primary);
    }

    .theme-emoji {
        font-size: 1.25rem;
    }

    .theme-label {
        flex: 1;
        text-align: left;
    }
}

.keyboard-hint {
    position: absolute;
    bottom: -2rem;
    right: 0;
    font-size: 0.75rem;
    color: var(--color-text-tertiary);
    white-space: nowrap;

    kbd {
        padding: 0.125rem 0.375rem;
        background: var(--color-bg-secondary);
        border: 1px solid var(--color-border);
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.7rem;
    }
}

@media (max-width: 768px) {
    .theme-switcher {
        bottom: 1rem;
        right: 1rem;
    }

    .theme-toggle {
        width: 48px;
        height: 48px;
        font-size: 1.25rem;
    }

    .keyboard-hint {
        display: none;
    }
}
</style>

<script>
class ThemeSwitcher {
    private toggle: HTMLButtonElement;
    private menu: HTMLDivElement;
    private options: NodeListOf<HTMLButtonElement>;
    private currentTheme: string;

    constructor() {
        this.toggle = document.querySelector('.theme-toggle')!;
        this.menu = document.querySelector('.theme-menu')!;
        this.options = document.querySelectorAll('.theme-option');

        // Load saved theme or detect system preference
        this.currentTheme = this.loadTheme();
        this.applyTheme(this.currentTheme);

        this.initializeEventListeners();
        this.watchSystemPreference();
    }

    private loadTheme(): string {
        const saved = localStorage.getItem('theme');
        if (saved) return saved;

        // Detect system preference
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            return 'dark';
        }

        return 'light';
    }

    private applyTheme(theme: string) {
        const html = document.documentElement;
        html.setAttribute('data-theme', theme);

        // Update colorScheme for native browser elements
        html.style.colorScheme = theme === 'dark' ? 'dark' : 'light';

        localStorage.setItem('theme', theme);
        this.currentTheme = theme;

        // Update active state
        this.options.forEach(option => {
            option.classList.toggle('active', option.dataset.theme === theme);
        });

        // Update icon
        this.updateIcon(theme);

        // Dispatch custom event
        window.dispatchEvent(new CustomEvent('themechange', { detail: { theme } }));
    }

    private updateIcon(theme: string) {
        const icons: Record<string, string> = {
            'light': '‚òÄÔ∏è',
            'dark': 'üåô',
            'sandiego-sunset': 'üåÖ',
            'california-ocean': 'üåä',
            'gallery-minimal': 'üñºÔ∏è'
        };

        this.toggle.querySelector('.theme-icon')!.textContent = icons[theme] || 'üé®';
    }

    private initializeEventListeners() {
        // Toggle menu
        this.toggle.addEventListener('click', () => {
            this.menu.hidden = !this.menu.hidden;
        });

        // Theme selection
        this.options.forEach(option => {
            option.addEventListener('click', () => {
                const theme = option.dataset.theme!;
                this.applyTheme(theme);
                this.menu.hidden = true;
            });
        });

        // Close menu on outside click
        document.addEventListener('click', (e) => {
            if (!e.target || !(e.target as Element).closest('.theme-switcher')) {
                this.menu.hidden = true;
            }
        });

        // Keyboard shortcut (Ctrl/Cmd + K)
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                this.menu.hidden = !this.menu.hidden;
            }
        });
    }

    private watchSystemPreference() {
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

        mediaQuery.addEventListener('change', (e) => {
            // Only auto-switch if user hasn't manually selected a theme
            const hasManualSelection = localStorage.getItem('theme');
            if (!hasManualSelection) {
                this.applyTheme(e.matches ? 'dark' : 'light');
            }
        });
    }
}

// Initialize on DOM ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => new ThemeSwitcher());
} else {
    new ThemeSwitcher();
}
</script>
